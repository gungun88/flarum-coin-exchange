(()=>{var o={n:n=>{var t=n&&n.__esModule?()=>n.default:()=>n;return o.d(t,{a:t}),t},d:(n,t)=>{for(var e in t)o.o(t,e)&&!o.o(n,e)&&Object.defineProperty(n,e,{enumerable:!0,get:t[e]})},o:(o,n)=>Object.prototype.hasOwnProperty.call(o,n)};(()=>{"use strict";const n=flarum.core.compat["forum/app"];var t=o.n(n);const e=flarum.core.compat["common/extend"],r=flarum.core.compat["forum/utils/UserControls"];var s=o.n(r);const a=flarum.core.compat["forum/components/UserPage"];var i=o.n(a);const c=flarum.core.compat["common/components/LinkButton"];var l=o.n(c);const u=flarum.core.compat["common/components/Button"];var d=o.n(u);function p(o,n){return p=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(o,n){return o.__proto__=n,o},p(o,n)}const h=flarum.core.compat["common/components/Modal"];var f=o.n(h);flarum.core.compat["common/components/LoadingIndicator"];var g=function(o){function n(){return o.apply(this,arguments)||this}var e,r;r=o,(e=n).prototype=Object.create(r.prototype),e.prototype.constructor=e,p(e,r);var s=n.prototype;return s.oninit=function(n){o.prototype.oninit.call(this,n),this.coinAmount=100,this.loading=!1,this.error=null,this.success=null,this.dailyLimit=t().forum.attribute("coinExchange.dailyLimit")||1e3,this.userMoney=t().session.user.data.attributes.money||0},s.className=function(){return"CoinExchangeModal Modal--small"},s.title=function(){return t().translator.trans("doingfb-coin-exchange.forum.modal.title")},s.content=function(){var o=this;return this.success?m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},m("div",{className:"Alert Alert--success"},m("p",null,this.success)),m("div",{className:"Form-group"},m(d(),{className:"Button Button--primary Button--block",onclick:function(){return t().modal.close()}},t().translator.trans("doingfb-coin-exchange.forum.modal.close"))))):m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},m("div",{className:"helpText",style:"margin-bottom: 20px;"},m("p",null,m("strong",null,"兑换比例:")," 1 积分 = 10 硬币"),m("p",null,m("strong",null,"每日限额:")," ",this.dailyLimit," 硬币"),m("p",null,m("strong",null,"当前余额:")," ",this.userMoney," 硬币")),this.error&&m("div",{className:"Alert Alert--error"},m("p",null,this.error)),m("div",{className:"Form-group"},m("label",null,t().translator.trans("doingfb-coin-exchange.forum.modal.coin_amount_label")),m("input",{className:"FormControl",type:"number",min:"10",step:"10",value:this.coinAmount,oninput:function(n){o.coinAmount=parseInt(n.target.value)||0,o.error=null},disabled:this.loading}),m("p",{className:"helpText"},"最少 10 硬币，必须是 10 的倍数。将获得 ",m("strong",null,this.coinAmount/10)," 积分")),m("div",{className:"Form-group"},m(d(),{className:"Button Button--primary Button--block",type:"submit",loading:this.loading,disabled:this.loading||this.coinAmount<10},t().translator.trans("doingfb-coin-exchange.forum.modal.submit")))))},s.onsubmit=function(o){var n=this;return o.preventDefault(),this.coinAmount<10?(this.error="最少需要兑换 10 硬币",void m.redraw()):this.coinAmount%10!=0?(this.error="硬币数量必须是 10 的倍数",void m.redraw()):this.coinAmount>this.userMoney?(this.error="硬币余额不足",void m.redraw()):this.coinAmount>this.dailyLimit?(this.error="超出每日限额 ("+this.dailyLimit+" 硬币)",void m.redraw()):(this.loading=!0,this.error=null,m.redraw(),void t().request({method:"POST",url:t().forum.attribute("apiUrl")+"/coin-exchange/convert",body:{coinAmount:this.coinAmount},errorHandler:!1}).then(function(o){n.success=o.message||"兑换成功！",n.loading=!1,o.data&&void 0!==o.data.remainingCoins&&(t().session.user.data.attributes.money=o.data.remainingCoins),m.redraw()}).catch(function(o){n.loading=!1;var t,e="兑换失败，请稍后再试";o.response?null!=(t=o.response.data)&&t.message?e=o.response.data.message:o.response.message?e=o.response.message:"string"==typeof o.response.data&&(e=o.response.data):o.message&&(e=o.message),n.error=e,m.redraw()}))},n}(f());t().initializers.add("doingfb/flarum-coin-exchange",function(){(0,e.extend)(s(),"userControls",function(o,n){t().session.user&&t().session.user.id()===n.id()&&t().forum.attribute("coinExchange.enabled")&&o.add("coin-exchange",d().component({icon:"fas fa-coins",onclick:function(){t().modal.show(g)}},t().translator.trans("doingfb-coin-exchange.forum.user_controls.coin_exchange_button")))}),(0,e.extend)(i().prototype,"navItems",function(o){var n=this.user;t().session.user&&n&&t().session.user.id()===n.id()&&t().forum.attribute("coinExchange.enabled")&&o.add("coin-exchange",l().component({href:"#",icon:"fas fa-coins",onclick:function(o){o.preventDefault(),t().modal.show(g)}},t().translator.trans("doingfb-coin-exchange.forum.user_controls.coin_exchange_button")),80)})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map