(()=>{var o={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return o.d(n,{a:n}),n},d:(t,n)=>{for(var r in n)o.o(n,r)&&!o.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(o,t)=>Object.prototype.hasOwnProperty.call(o,t)};(()=>{"use strict";const t=flarum.core.compat["forum/app"];var n=o.n(t);const r=flarum.core.compat["common/extend"],e=flarum.core.compat["forum/utils/UserControls"];var i=o.n(e);const a=flarum.core.compat["common/components/Button"];var s=o.n(a);function c(o,t){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(o,t){return o.__proto__=t,o},c(o,t)}const l=flarum.core.compat["common/components/Modal"];var u=o.n(l);flarum.core.compat["common/components/LoadingIndicator"];var d=function(o){function t(){return o.apply(this,arguments)||this}var r,e;e=o,(r=t).prototype=Object.create(e.prototype),r.prototype.constructor=r,c(r,e);var i=t.prototype;return i.oninit=function(t){o.prototype.oninit.call(this,t),this.coinAmount=100,this.loading=!1,this.error=null,this.success=null,this.dailyLimit=n().forum.attribute("coinExchange.dailyLimit")||1e3,this.userMoney=n().session.user.data.attributes.money||0},i.className=function(){return"CoinExchangeModal Modal--small"},i.title=function(){return n().translator.trans("doingfb-coin-exchange.forum.modal.title")},i.content=function(){var o=this;return this.success?m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},m("div",{className:"Alert Alert--success"},m("p",null,this.success)),m("div",{className:"Form-group"},m(s(),{className:"Button Button--primary Button--block",onclick:function(){return n().modal.close()}},n().translator.trans("doingfb-coin-exchange.forum.modal.close"))))):m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},m("div",{className:"helpText",style:"margin-bottom: 20px;"},m("p",null,m("strong",null,"兑换比例:")," 1 积分 = 10 硬币"),m("p",null,m("strong",null,"每日限额:")," ",this.dailyLimit," 硬币"),m("p",null,m("strong",null,"当前余额:")," ",this.userMoney," 硬币")),this.error&&m("div",{className:"Alert Alert--error"},m("p",null,this.error)),m("div",{className:"Form-group"},m("label",null,n().translator.trans("doingfb-coin-exchange.forum.modal.coin_amount_label")),m("input",{className:"FormControl",type:"number",min:"10",step:"10",value:this.coinAmount,oninput:function(t){o.coinAmount=parseInt(t.target.value)||0,o.error=null},disabled:this.loading}),m("p",{className:"helpText"},"最少 10 硬币，必须是 10 的倍数。将获得 ",m("strong",null,this.coinAmount/10)," 积分")),m("div",{className:"Form-group"},m(s(),{className:"Button Button--primary Button--block",type:"submit",loading:this.loading,disabled:this.loading||this.coinAmount<10},n().translator.trans("doingfb-coin-exchange.forum.modal.submit")))))},i.onsubmit=function(o){var t=this;return o.preventDefault(),this.coinAmount<10?(this.error="最少需要兑换 10 硬币",void m.redraw()):this.coinAmount%10!=0?(this.error="硬币数量必须是 10 的倍数",void m.redraw()):this.coinAmount>this.userMoney?(this.error="硬币余额不足",void m.redraw()):this.coinAmount>this.dailyLimit?(this.error="超出每日限额 ("+this.dailyLimit+" 硬币)",void m.redraw()):(this.loading=!0,this.error=null,m.redraw(),void n().request({method:"POST",url:n().forum.attribute("apiUrl")+"/coin-exchange/convert",body:{coinAmount:this.coinAmount}}).then(function(o){t.success=o.message||"兑换成功！",t.loading=!1,o.data&&void 0!==o.data.remainingCoins&&(n().session.user.data.attributes.money=o.data.remainingCoins),m.redraw()}).catch(function(o){var n;t.loading=!1,t.error=(null==(n=o.response)||null==(n=n.data)?void 0:n.message)||o.message||"兑换失败，请稍后再试",m.redraw()}))},t}(u());n().initializers.add("doingfb/flarum-coin-exchange",function(){(0,r.extend)(i(),"userControls",function(o,t){n().session.user&&n().session.user.id()===t.id()&&n().forum.attribute("coinExchange.enabled")&&o.add("coin-exchange",s().component({icon:"fas fa-coins",onclick:function(){n().modal.show(d)}},n().translator.trans("doingfb-coin-exchange.forum.user_controls.coin_exchange_button")))})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map